// Atomic-UI Database Schema
// Advanced Outline VPN Management Platform
// Author: sankahchan
//
// Note: SQLite doesn't support native enums, so we use String types
// with application-level validation instead. Valid values are documented
// in comments for each field.

generator client {
  provider      = "prisma-client-js"
  // Binary targets for different platforms:
  // - native: Current development machine
  // - darwin-arm64: macOS Apple Silicon
  // - debian-openssl-3.0.x: Ubuntu 22.04+ / Debian 12+
  // - linux-musl-openssl-3.0.x: Alpine Linux
  binaryTargets = ["native", "darwin-arm64", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// Authentication & Users
// ============================================

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  passwordHash   String?   // Nullable for passwordless/magic link flow if we go that route
  role           String    @default("USER") // Valid: ADMIN, USER
  telegramChatId String?   // Telegram chat ID for bot notifications
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  accessKeys      AccessKey[]
  dynamicAccessKeys DynamicAccessKey[]
  sessions        Session[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  ip        String?
  userAgent String?
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

// ============================================
// Server Management
// ============================================

model Server {
  id            String   @id @default(cuid())
  name          String
  apiUrl        String
  apiCertSha256 String
  location      String?
  countryCode   String?
  isDefault     Boolean  @default(false)
  isActive      Boolean  @default(true)
  maxKeys       Int?
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  tags        ServerTag[]
  accessKeys  AccessKey[]
  healthCheck HealthCheck?
  metrics     ServerMetric[]
  keyTemplates KeyTemplate[]

  // Cached server info from Outline API
  outlineServerId       String?
  outlineName           String?
  outlineVersion        String?
  hostnameForAccessKeys String?
  portForNewAccessKeys  Int?
  metricsEnabled        Boolean   @default(true)
  lastSyncAt            DateTime?
}

model Tag {
  id          String      @id @default(cuid())
  name        String      @unique
  color       String      @default("#06b6d4") // Cyan default
  description String?
  servers     ServerTag[]
  createdAt   DateTime    @default(now())
}

model ServerTag {
  serverId String
  tagId    String
  server   Server @relation(fields: [serverId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([serverId, tagId])
}

// ============================================
// Access Key Management
// ============================================

model AccessKey {
  id           String  @id @default(cuid())
  outlineKeyId String // ID from Outline API
  name         String
  email        String?
  telegramId   String?
  notes        String?

  // User Ownership
  userId       String?
  user         User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Server relation
  serverId String
  server   Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  // Access key details from Outline
  accessUrl String?
  password  String?
  port      Int?
  method    String?

  // Traffic limits (in bytes)
  dataLimitBytes BigInt?
  usedBytes      BigInt  @default(0)
  
  // Periodic Data Limits
  // Strategy: DAILY, WEEKLY, MONTHLY, NEVER
  dataLimitResetStrategy String    @default("NEVER")
  lastDataLimitReset     DateTime?
  usageOffset            BigInt    @default(0) // Total usage at start of period

  // Expiration settings
  // Valid expirationType: NEVER, FIXED_DATE, DURATION_FROM_CREATION, START_ON_FIRST_USE
  expirationType String    @default("NEVER")
  expiresAt      DateTime?
  durationDays   Int? // For START_ON_FIRST_USE

  // Status tracking
  // Valid status: ACTIVE, DISABLED, EXPIRED, DEPLETED, PENDING
  status      String    @default("ACTIVE")
  firstUsedAt DateTime?
  lastUsedAt  DateTime?
  lastWarningSentAt DateTime?

  // Bandwidth alerts & auto-disable
  bandwidthAlertAt80 Boolean   @default(false) // true if 80% alert already sent
  bandwidthAlertAt90 Boolean   @default(false) // true if 90% alert already sent
  autoDisableOnLimit Boolean   @default(true)  // auto-disable when 100% reached
  
  // Disable tracking - when DISABLED, key is deleted from Outline server
  // but kept in DB for potential re-enabling
  disabledAt          DateTime?
  disabledOutlineKeyId String?   // Original Outline key ID when disabled (for reference)

  // Dynamic key association
  dynamicKeyId String?
  dynamicKey   DynamicAccessKey? @relation(fields: [dynamicKeyId], references: [id], onDelete: SetNull)

  // Prefix for obfuscation
  prefix String?

  // Subscription
  subscriptionToken String? @unique

  // Subscription page theme (overrides global default)
  // Valid themes: dark, light, purple, blue, green, orange, pink, red
  subscriptionTheme String?

  // Subscription page cover image
  // coverImageType: upload, unsplash, gradient, url
  coverImageType String?
  coverImage     String? // Path for upload, URL for unsplash/url, gradient name for gradient

  // Contact links for subscription page (JSON array of up to 3 contacts)
  // Format: [{"type": "telegram", "value": "https://t.me/user"}, ...]
  // Valid types: telegram, discord, whatsapp, phone, email, website, facebook
  contactLinks   String?

  // Connection/device tracking
  estimatedDevices Int @default(0)
  peakDevices      Int @default(0)

  // Ownership and tagging
  owner String?              // Owner/email for this key
  tags  String @default("")  // Comma-separated tags

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  trafficLogs TrafficLog[]
  notifications NotificationLog[]
  sessions    ConnectionSession[]

  @@unique([serverId, outlineKeyId])
  @@index([status])
  @@index([expiresAt])
  @@index([userId])
  @@index([serverId])
}

model DynamicAccessKey {
  id   String @id @default(cuid())
  name String
  type String @default("SELF_MANAGED") // Valid: SELF_MANAGED, MANUAL

  // Contact information (for tracking/notification purposes)
  email      String?
  telegramId String?
  notes      String?

  // User Ownership
  userId     String?
  user       User?   @relation(fields: [userId], references: [id], onDelete: SetNull)


  // For tag-based server selection (stored as JSON string)
  serverTagsJson String @default("[]")

  // Limits
  dataLimitBytes BigInt?
  usedBytes      BigInt    @default(0)

  // Periodic Limits
  dataLimitResetStrategy String    @default("NEVER")
  lastDataLimitReset     DateTime?
  usageOffset            BigInt    @default(0)

  expiresAt      DateTime?
  durationDays   Int?
  expirationType String    @default("NEVER") // Same values as AccessKey

  // Status
  status      String    @default("ACTIVE") // Same values as AccessKey
  firstUsedAt DateTime?

  // Dynamic URL
  dynamicUrl String? @unique

  // Protocol obfuscation prefix (for protocol obfuscation)
  prefix String?

  // Encryption method for Shadowsocks
  method String @default("chacha20-ietf-poly1305")

  // Ownership and tagging
  owner String?              // Owner/email for this key
  tags  String @default("")  // Comma-separated tags

  @@index([userId])

  // Load balancer algorithm for selecting access keys
  // Valid: IP_HASH, RANDOM, ROUND_ROBIN
  loadBalancerAlgorithm String @default("IP_HASH")

  // Track which server was last selected (for round-robin)
  lastSelectedKeyIndex Int @default(0)

  // Subscription page theme (overrides global default)
  // Valid themes: dark, light, purple, blue, green, orange, pink, red, glass*
  subscriptionTheme String?

  // Subscription page cover image
  // coverImageType: upload, url, gradient
  coverImageType String?
  coverImage     String?

  // Contact links for subscription page (JSON array of up to 3 contacts)
  // Format: [{"type": "telegram", "value": "https://t.me/user"}, ...]
  contactLinks   String?

  accessKeys AccessKey[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TrafficLog {
  id          String    @id @default(cuid())
  accessKeyId String
  accessKey   AccessKey @relation(fields: [accessKeyId], references: [id], onDelete: Cascade)

  // Historical Analytics (Phase 8)
  bytesUsed   BigInt   // Cumulative at time of log
  deltaBytes  BigInt   @default(0) // Usage since last log

  recordedAt DateTime @default(now())

  @@index([accessKeyId, recordedAt])
}

// ============================================
// Connection Sessions (for device tracking)
// ============================================

model ConnectionSession {
  id          String    @id @default(cuid())
  accessKeyId String
  accessKey   AccessKey @relation(fields: [accessKeyId], references: [id], onDelete: Cascade)

  // Session timing
  startedAt   DateTime  @default(now())
  endedAt     DateTime?
  lastActiveAt DateTime @default(now())

  // Traffic during this session
  bytesUsed   BigInt    @default(0)

  // Is this session currently active?
  isActive    Boolean   @default(true)

  @@index([accessKeyId, isActive])
  @@index([accessKeyId, startedAt])
}

// ============================================
// Archived Keys (for expired/deleted/depleted keys)
// ============================================

model ArchivedKey {
  id             String   @id @default(cuid())
  originalKeyId  String   // Original AccessKey ID
  outlineKeyId   String   // ID from Outline API
  name           String
  email          String?
  telegramId     String?
  notes          String?

  // Server info (stored since original might be deleted)
  serverName     String
  serverLocation String?

  // Access key details
  accessUrl      String?

  // Traffic data
  dataLimitBytes BigInt?
  usedBytes      BigInt   @default(0)

  // Expiration info
  expirationType String
  expiresAt      DateTime?
  durationDays   Int?

  // Archive reason: EXPIRED, DEPLETED, DELETED, DISABLED
  archiveReason  String

  // Status at time of archival
  originalStatus String

  // Timestamps
  firstUsedAt    DateTime?
  lastUsedAt     DateTime?
  createdAt      DateTime  // Original creation date
  archivedAt     DateTime  @default(now())

  // Auto-delete after 3 months
  deleteAfter    DateTime

  @@index([archiveReason])
  @@index([archivedAt])
  @@index([deleteAfter])
}

// ============================================
// Health Monitoring
// ============================================

model HealthCheck {
  id       String @id @default(cuid())
  serverId String @unique
  server   Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  isEnabled          Boolean @default(true)
  checkIntervalMins  Int     @default(5)
  notifyCooldownMins Int     @default(30)
  latencyThresholdMs Int     @default(500)

  // Valid lastStatus: UP, DOWN, SLOW, UNKNOWN
  lastStatus     String    @default("UNKNOWN")
  lastLatencyMs  Int?
  lastCheckedAt  DateTime?
  lastNotifiedAt DateTime?

  uptimePercent    Float @default(100)
  totalChecks      Int   @default(0)
  successfulChecks Int   @default(0)
  failedChecks     Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ServerMetric {
  id       String @id @default(cuid())
  serverId String
  server   Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  cpuPercent    Float?
  memoryPercent Float?
  diskPercent   Float?
  bytesIn       BigInt?
  bytesOut      BigInt?
  activeKeys    Int?

  recordedAt DateTime @default(now())

  @@index([serverId, recordedAt])
}

// ============================================
// Notifications
// ============================================

model NotificationChannel {
  id       String  @id @default(cuid())
  type     String // Valid: TELEGRAM, EMAIL, WEBHOOK
  name     String
  config   String // JSON config (bot token, chat ID, etc.)
  events   String // JSON array of NotificationEvent
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NotificationLog {
  id        String   @id @default(cuid())
  channelId String?
  event     String
  message   String
  status    String // SUCCESS, FAILED
  error     String?
  sentAt    DateTime @default(now())
  
  // Optional relation to access key
  accessKeyId String?
  accessKey   AccessKey? @relation(fields: [accessKeyId], references: [id], onDelete: SetNull)
}

// ============================================
// Settings & Misc
// ============================================

model Settings {
  key   String @id
  value String // JSON value

  @@map("settings")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  details   String? // JSON
  ip        String?
  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([createdAt])
}

// ============================================
// Type Definitions (for application-level validation)
// ============================================
// 
// Role values: ADMIN, STAFF, VIEWER
// KeyStatus values: ACTIVE, DISABLED, EXPIRED, DEPLETED, PENDING
// ExpirationType values: NEVER, FIXED_DATE, DURATION_FROM_CREATION, START_ON_FIRST_USE
// DakType values: SELF_MANAGED, MANUAL
// HealthStatus values: UP, DOWN, SLOW, UNKNOWN
// NotificationType values: TELEGRAM, EMAIL, WEBHOOK

// ============================================
// Access Key Templates
// ============================================

model KeyTemplate {
  id          String   @id @default(cuid())
  name        String   // Template name (e.g., "Standard 30 Day")
  description String?

  // Key Configuration
  namePrefix             String? // Prefix for generated keys
  dataLimitBytes         BigInt?
  dataLimitResetStrategy String  @default("NEVER")
  expirationType         String  @default("NEVER")
  durationDays           Int?    // For DURATION_FROM_CREATION or START_ON_FIRST_USE
  method                 String  @default("chacha20-ietf-poly1305")
  
  // Customization
  notes                  String? // Default notes
  
  // Default server (optional)
  serverId               String?
  server                 Server? @relation(fields: [serverId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// Security & Access Control
// ============================================

model SecurityRule {
  id          String   @id @default(cuid())

  // Rule Type: ALLOW (Whitelist) or BLOCK (Blacklist)
  type        String   @default("BLOCK")

  // Target: IP, CIDR, COUNTRY
  // Valid: IP, CIDR, COUNTRY
  targetType  String

  // Value: 192.168.1.1, 10.0.0.0/24, US, CN
  targetValue String

  description String?
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type, targetType])
}

// ============================================
// Analytics & Usage Tracking
// ============================================

model UsageSnapshot {
  id        String   @id @default(cuid())

  // Optional server reference (for server-level aggregates)
  serverId  String?

  // Optional key reference (for per-key snapshots)
  keyId     String?

  // Key type: ACCESS_KEY or DYNAMIC_KEY
  keyType   String?

  // Cumulative usage in bytes at this point in time
  usedBytes BigInt

  // Delta since last snapshot (calculated by worker)
  deltaBytes BigInt   @default(0)

  createdAt DateTime @default(now())

  @@index([keyId, createdAt])
  @@index([serverId, createdAt])
  @@index([createdAt])
}

// ============================================
// Background Worker Coordination
// ============================================

model WorkerLock {
  id          String   @id @default("usage-snapshot-worker")

  // Worker that holds the lock
  workerId    String

  // Lock acquisition time
  lockedAt    DateTime @default(now())

  // Lock expiration (auto-release if worker crashes)
  expiresAt   DateTime

  // Last heartbeat from the worker
  heartbeatAt DateTime @default(now())
}

// ============================================
// Two-Factor Authentication (2FA)
// ============================================

model TotpSecret {
  id              String   @id @default(cuid())
  userId          String   @unique

  // Encrypted TOTP secret (base32 encoded, then encrypted)
  encryptedSecret String

  // Whether 2FA has been verified/enabled
  verified        Boolean  @default(false)

  // Track verification attempts (for rate limiting)
  lastAttemptAt   DateTime?
  attemptCount    Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model RecoveryCode {
  id        String    @id @default(cuid())
  userId    String

  // Hashed recovery code (bcrypt)
  codeHash  String

  // When was this code used (null = not used)
  usedAt    DateTime?

  createdAt DateTime  @default(now())

  @@index([userId])
}

// ============================================
// WebAuthn Passkeys
// ============================================

model WebAuthnCredential {
  id              String   @id @default(cuid())
  userId          String

  // WebAuthn credential data
  credentialId    String   @unique // Base64 encoded
  publicKey       String   // Base64 encoded COSE public key
  counter         Int      @default(0)

  // Credential metadata
  deviceType      String?  // platform, cross-platform
  transports      String?  // JSON array: ["usb", "nfc", "ble", "internal"]

  // User-friendly name for the credential
  name            String   @default("Security Key")

  // Track last use
  lastUsedAt      DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// ============================================
// Security Probes (TLS/Certificate Monitoring)
// ============================================

model SecurityProbe {
  id            String   @id @default(cuid())
  serverId      String   @unique

  // TLS/Connection details
  scheme        String?  // http, https
  tlsVersion    String?  // TLSv1.2, TLSv1.3
  cipherSuite   String?

  // Certificate details
  certSubject   String?
  certIssuer    String?
  certExpiry    DateTime?
  certDaysLeft  Int?

  // Security headers
  hasHsts       Boolean  @default(false)
  hstsMaxAge    Int?

  // Probe result
  // Valid: OK, CERT_EXPIRING, CERT_EXPIRED, TLS_ERROR, CONNECTION_ERROR
  result        String   @default("UNKNOWN")
  errorMessage  String?

  // Timestamps
  lastCheckedAt DateTime?
  nextCheckAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============================================
// Dashboard Security Settings
// ============================================

model DashboardSecurityProbe {
  id            String   @id @default("dashboard-security")

  // Current dashboard URL being probed
  dashboardUrl  String?

  // TLS/Connection details
  scheme        String?  // http, https
  tlsVersion    String?

  // Security headers
  hasHsts       Boolean  @default(false)
  hstsMaxAge    Int?
  hasSecureCookies Boolean @default(false)
  hasHttpOnlyCookies Boolean @default(false)
  hasSameSiteCookies Boolean @default(false)

  // Content Security Policy
  hasCsp        Boolean  @default(false)
  cspDirectives String?  // JSON

  // Other headers
  hasXFrameOptions Boolean @default(false)
  hasXContentTypeOptions Boolean @default(false)

  // Probe result
  result        String   @default("UNKNOWN")
  errorMessage  String?

  // Overall security score (0-100)
  securityScore Int      @default(0)

  lastCheckedAt DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
